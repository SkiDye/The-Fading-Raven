# 세션 4: 캠페인 & 진행

## 담당 범위
- 섹터 맵 개선
- 노드 타입 확장
- 크루 영입/관리
- 메타 진행 시스템

## 구현 항목
1. **섹터 맵 생성** (`js/core/sector-generator.js`)
   - DAG 구조 (15-25 레이어)
   - 노드 타입 분포
   - Storm Front 시스템

2. **노드 타입 확장**
   - Commander (크루 영입)
   - Equipment (장비 획득)
   - Storm (위험/보상)
   - Boss (보스전)
   - Gate (최종 목표)

3. **정거장 레이아웃 생성** (`js/core/station-generator.js`)
   - BSP 기반 방 생성
   - 시설 배치
   - 스폰 포인트

4. **크루 관리 시스템**
   - 영입 시스템
   - 특성 부여
   - 영구 사망 처리

5. **메타 진행** (`js/core/meta-progress.js`)
   - 클래스 해금
   - 장비 해금
   - 특성 해금
   - 도전 과제

## 산출물
- 개선된 `sector.js`
- `js/core/station-generator.js`
- `docs/implementation/campaign-system.md`

---

## 통합 테스트 피드백 (2026-02-03)

### 테스트 결과
```
Session 4: Campaign System - 17/17 ✓ (100%)
```

### 검증된 항목
- [x] SectorGenerator 로드 및 API
  - generate, visitNode, advanceStormFront 함수
  - NODE_TYPES 상수
  - 섹터맵 생성 (노드 10개 이상)
  - start/gate 노드 존재 확인
- [x] StationGenerator 로드 및 API
  - generate, isWalkable, TILE 상수
  - 레이아웃 크기 확인
  - 시설 및 스폰포인트 생성 확인
- [x] MetaProgress 로드 및 API
  - isClassUnlocked, isEquipmentUnlocked
  - getStats, processRunCompletion
  - 기본 클래스 해금 확인 (Guardian, Sentinel, Ranger)

### 발견된 이슈
없음 - 모든 테스트 통과

### 섹터 생성 검증 결과
```javascript
// 시드 12345 테스트
섹터맵 생성: 성공
노드 수: 15개 이상
start 노드: 존재
gate 노드: 존재
```

### 스테이션 생성 검증 결과
```javascript
// 난이도 5 테스트
레이아웃 크기: 적절
시설 수: 3개 이상
스폰포인트: 2개 이상
```

### 메타 진행 검증 결과
- Guardian: 기본 해금 ✓
- Sentinel: 기본 해금 ✓
- Ranger: 기본 해금 ✓
- Engineer: 조건부 해금 (정상)
- Bionic: 조건부 해금 (정상)

### 권장 개선사항
1. Storm Front 진행 속도 밸런스 테스트
2. 노드 타입 분포 비율 검토
3. 해금 조건 달성 테스트 (수동 플레이 필요)

---

## UX 플로우 검증 피드백 (2026-02-03)

### Critical Issues (게임 진행 불가)

#### C-001: victory.html 페이지 미구현
**우선순위:** Critical
**상태:** Resolved (이미 구현됨 - demo/pages/victory.html, demo/js/pages/victory.js)

**설명:**
게임 클리어(Gate 도달) 시 이동할 victory.html 페이지가 존재하지 않음.
게임을 끝까지 클리어해도 404 에러 발생.

**영향:**
- 게임 클리어 불가능
- 메타 진행 저장 불가
- 플레이어 경험 완전히 깨짐

**필요 구현:**
```html
<!-- pages/victory.html -->
- 클리어 축하 메시지
- 최종 점수/통계 표시
- 해금된 아이템 표시
- 메인 메뉴/재시작 버튼
```

**연관 파일:**
- `js/core/meta-progress.js` - processRunCompletion() 호출 필요

---

#### C-002: gameover.html 페이지 미구현
**우선순위:** Critical
**상태:** Resolved (이미 구현됨 - demo/pages/gameover.html, demo/js/pages/gameover.js)

**설명:**
게임 오버 시 이동할 gameover.html 페이지가 존재하지 않음.
모든 크루 사망 또는 Storm Front에 흡수되어도 404 에러.

**영향:**
- 게임 오버 처리 불가
- 런 통계 확인 불가
- 재시작/메뉴 이동 불가

**필요 구현:**
```html
<!-- pages/gameover.html -->
- 사망 원인 표시 (크루 전멸/스톰 흡수)
- 도달 깊이/점수 표시
- 재시작/메인 메뉴 버튼
```

---

#### C-003: 사망한 크루 배치 가능 버그
**우선순위:** Critical
**상태:** Resolved (deploy.js에서 GameState.getAliveCrews() 사용으로 생존 크루만 표시)

**설명:**
deploy.html에서 사망한(currentSquadSize: 0) 크루도
배치 가능 상태로 표시됨. 배치 시 전투 중 오류 발생 가능.

**재현 방법:**
1. 전투에서 크루 전원 사망
2. sector.html로 귀환
3. 다음 전투 노드 진입
4. deploy.html에서 사망 크루 선택 가능

**권장 조치:**
```javascript
// deploy.js
function renderCrewSlot(crew) {
    if (crew.currentSquadSize <= 0) {
        slot.classList.add('dead');
        slot.setAttribute('disabled', true);
        // "사망" 표시 추가
    }
}
```

---

#### C-004: 시드 검증 없이 진행
**우선순위:** Critical
**상태:** Resolved (menu.js에서 SeedUtils.isValidSeedString()으로 검증)

**설명:**
newrun.html에서 잘못된 시드 입력 시 검증 없이 게임 시작됨.
빈 시드, 특수문자, 매우 긴 시드 등이 예외 발생 가능.

**권장 조치:**
```javascript
function validateSeed(seed) {
    if (!seed || seed.length === 0) {
        return { valid: false, error: '시드를 입력해주세요' };
    }
    if (seed.length > 20) {
        return { valid: false, error: '시드는 20자 이하로 입력해주세요' };
    }
    // 영숫자만 허용
    if (!/^[a-zA-Z0-9]+$/.test(seed)) {
        return { valid: false, error: '시드는 영문자와 숫자만 사용 가능합니다' };
    }
    return { valid: true };
}
```

---

### High Priority Issues

#### H-002: 필수 HTML 요소 누락 가능성
**우선순위:** High

**설명:**
일부 페이지에서 JavaScript가 참조하는 HTML 요소가
누락되어 있을 수 있음. querySelector 실패 시 에러 발생.

**검증 필요 페이지:**
- sector.html: #sector-map, #storm-indicator
- deploy.html: #crew-list, #deploy-slots
- upgrade.html: #skill-panel, #equipment-panel

**권장 조치:**
```javascript
// 안전한 요소 접근
function safeQuerySelector(selector) {
    const el = document.querySelector(selector);
    if (!el) {
        console.error(`Required element not found: ${selector}`);
        return null;
    }
    return el;
}
```

---

#### H-003: Storm Front 경로 차단 문제
**우선순위:** High
**상태:** Resolved (sector.js에서 hasPathToGate() 체크 및 경고 표시)

**설명:**
Storm Front가 진행되며 유일한 경로를 차단할 수 있음.
플레이어가 gate에 도달할 경로가 없어지면 게임 진행 불가.

**재현 조건:**
- 섹터맵에서 특정 깊이에 노드가 1개만 있을 때
- 해당 노드가 Storm에 잠식되면 진행 불가

**권장 조치:**
1. 섹터 생성 시 항상 2개 이상 경로 보장
2. 또는 Storm 진행 시 최소 1개 경로 유지
3. 또는 Storm에 잠식된 노드 강제 통과 메카닉 (높은 위험)

---

### Medium Priority Issues

#### M-011: 노드 타입별 아이콘/색상 구분 부족
**우선순위:** Medium
**상태:** Resolved (NODE_CONFIG에 각 타입별 icon/color/name 정의됨)

**설명:**
섹터맵에서 노드 타입(battle, shop, event 등)이
시각적으로 명확히 구분되지 않음.

**권장 조치:**
- 각 노드 타입별 고유 아이콘
- 색상 코드 (전투: 빨강, 상점: 노랑, 이벤트: 파랑)
- 호버 시 노드 정보 툴팁

---

#### M-012: 크루 영입 시 비교 정보 부족
**우선순위:** Medium
**상태:** Resolved (result.js에 displayRecruitment() 구현)

**설명:**
Commander 노드에서 새 크루 영입 시
기존 크루와의 비교 정보가 제공되지 않음.

**구현 완료:**
- result.html에 recruitment-panel 섹션 추가
- result.js에 displayRecruitment() 메서드 구현
- 새 크루 스탯 표시 및 기존 크루와 HP/공격력/방어력 비교
- 영입/거절 버튼으로 즉시 결정 가능
- result.css에 관련 스타일 추가

---

#### M-013: 장비 획득 시 장착 UI 부재
**우선순위:** Medium
**상태:** Resolved (result.js에 displayEquipmentAcquisition() 구현)

**설명:**
Equipment 노드에서 장비 획득 후 바로 장착하는 UI 없음.
upgrade.html로 별도 이동 필요.

**구현 완료:**
- result.html에 equipment-panel 섹션 추가
- result.js에 displayEquipmentAcquisition() 메서드 구현
- 획득 장비 정보 및 스탯 표시
- 생존 크루 목록에서 즉시 장착 가능
- "업그레이드로 이동" 버튼 추가
- result.css에 관련 스타일 추가

---

### Low Priority Issues

#### L-011: Storm 노드 위험/보상 정보 부족
**우선순위:** Low
**상태:** Resolved (sector.js에 _displayStormDetails() 구현)

**설명:**
Storm 노드 진입 전 예상 위험과 보상 정보가 불명확함.

**구현 완료:**
- sector.html에 popup-storm-info 섹션 추가
- sector.js에 _displayStormDetails() 메서드 구현
- 위험 요소: 환경 피해, 적 체력/공격력 증가, 시야 제한 표시
- 추가 보상: 보너스 크레딧, 희귀 장비 확률, 경험치 보너스 표시
- sector.css에 관련 스타일 추가

---

#### L-012: 섹터맵 줌/팬 기능 부재
**우선순위:** Low
**상태:** Resolved (sector.js에 zoom/pan 기능 구현)

**설명:**
긴 섹터맵에서 전체를 조망하기 어려움.
줌 아웃 또는 드래그 스크롤 기능 필요.

**구현 완료:**
- sector.html에 map-controls (줌 버튼), depth-indicator, pan-hint 추가
- sector.js에 zoom/pan 상태 관리 및 이벤트 핸들러 구현
- 마우스 휠 줌, 드래그 팬, 터치 지원
- 키보드 단축키: +/- (줌), 0 (리셋)
- 좌표 변환 (screenToMap) 구현
- sector.css에 관련 스타일 추가

---

### 페이지별 플로우 검증

| 페이지 | 진입 조건 | 이탈 경로 | 상태 |
|--------|----------|----------|------|
| difficulty.html | 메뉴에서 | sector.html | ✓ 시드 검증 완료 |
| sector.html | difficulty/battle | 노드별 이동 | ✓ 경로 차단 경고 |
| deploy.html | sector(battle) | battle.html | ✓ 생존 크루만 표시 |
| battle.html | deploy | sector/result | ✓ |
| result.html | battle | sector | ✓ |
| upgrade.html | sector | sector | ✓ |
| victory.html | sector(gate) | menu | ✓ 구현 완료 |
| gameover.html | battle/sector | menu | ✓ 구현 완료 |

---

### 추가 검증 필요 항목
1. [ ] 모든 노드 타입 진입/완료 테스트
2. [ ] Storm Front 장기 플레이 시 경로 문제
3. [ ] 크루 4명 관리 (최대치) 테스트
4. [ ] 메타 진행 해금 조건 달성 테스트

---

## UI/UX 종합 개선 (2026-02-03)

### 적용된 개선사항

#### 1. 반응형 레이아웃 개선
- **common.css**: 태블릿(1024px), 모바일(768px), 소형 모바일(480px) 브레이크포인트 추가
- **sector.css**: 맵 컨트롤 크기 증가 (36px → 44px), 모바일 크루 로스터 최적화
- **deploy.css**: 모바일에서 세로 레이아웃으로 전환, 사이드바 스크롤 가능
- **battle.css**: 하단 HUD 모바일 최적화, 버튼 크기 44px 이상 보장
- **upgrade.css**: 그리드 최소 크기 감소 (320px → 280px), 카드 간격 최적화
- **result.css**: 모든 패널에 모바일 반응형 스타일 추가

#### 2. 접근성 개선
- **포커스 스타일**: 모든 버튼에 `focus-visible` 스타일 추가
- **버튼 크기**: WCAG 권장 최소 터치 타겟 44x44px 준수
- **모달**: 모바일에서 전체 화면 모달로 전환

#### 3. 사용자 피드백 시스템
- **토스트 알림**: `.toast-container` 및 `.toast` 스타일 추가 (success/error/warning)
- **버튼 상태**: 비활성 상태 시각적 피드백 개선

#### 4. 레이아웃 일관성
- **스페이싱**: 반응형 CSS 변수 조정
- **타이포그래피**: 모바일 폰트 크기 자동 조정
- **패딩**: 페이지별 일관된 패딩 적용

### 파일별 변경사항

| 파일 | 변경 내용 |
|------|----------|
| `common.css` | 포커스 스타일, 토스트, 3단계 미디어 쿼리 |
| `sector.css` | 맵 컨트롤, 깊이 표시기, 모바일 HUD |
| `deploy.css` | 사이드바 반응형, 크루 카드 그리드 |
| `battle.css` | 하단 HUD 레이아웃, 버튼 크기 |
| `upgrade.css` | 카드 그리드, 디테일 패널 |
| `result.css` | 모든 패널 반응형 스타일 |

---

## 전투 시스템 Phase 1 개선 (2026-02-03)

### 구현 항목

#### 1. 공격 예비 동작 (Windup) 애니메이션
**상태:** 완료

**설명:**
공격이 즉시 적중하지 않고 150ms의 예비 동작 후 발동되도록 변경.
시각적으로 공격 타이밍을 예측할 수 있게 함.

**구현 내용:**
- `crewAttack()`: 공격 전 `attack_windup` 이펙트 추가
- `enemyAttack()`: 적 공격에도 동일한 windup 적용
- 원거리(Ranger): 조준선 표시 후 발사
- 근거리: 공격 호 표시 후 타격

**효과 타입:**
```javascript
{
    type: 'attack_windup',
    duration: 150,
    isRanged: boolean, // 원거리 여부에 따라 다른 시각 효과
}
```

---

#### 2. 크리티컬 히트 시각적 구분
**상태:** 완료

**설명:**
크리티컬 히트 발생 시 황색 텍스트, "!" 마커, 파티클 효과로 구분.

**구현 내용:**
- 기본 크리티컬 확률: 15%
- `precision` 특성 보유 시: 20%
- 크리티컬 데미지: 1.5배

**시각 효과:**
- 데미지 텍스트: 황색(#ffd700), 더 큰 폰트(18px), "!" 접미사
- `crit_particle`: 8방향 황색 파티클 방출
- `crit_flash`: 타격 지점 황색 플래시

**관련 함수:**
```javascript
addCriticalHitEffect(x, y, color) // 크리티컬 파티클 생성
addDamageNumber(x, y, damage, isCrewDamage, isCritical) // 크리티컬 표시 지원
```

---

#### 3. 유닛 방향 표시 (Direction Indicator)
**상태:** 완료

**설명:**
유닛이 바라보는 방향을 삼각형 화살표로 표시하여
공격 대상이나 이동 방향을 직관적으로 파악 가능.

**구현 내용:**
- `renderCrew()`: 크루 주변에 방향 삼각형 표시
- `renderEnemy()`: 적 유닛도 방향 표시
- `facingAngle` 속성으로 방향 관리

**방향 결정 우선순위:**
1. `facingAngle` 직접 설정 (공격 시)
2. `targetEnemy` 방향 (전투 중)
3. 이동 경로의 다음 타일 방향 (이동 중)

**시각 표현:**
- 유닛 외곽에서 바라보는 방향으로 작은 삼각형
- 크루: 유닛 색상과 동일
- 적: 적 색상, 0.8 투명도

---

### 변경된 파일

| 파일 | 변경 내용 |
|------|----------|
| `battle.js` | crewAttack, enemyAttack에 windup 추가 |
| `battle.js` | 크리티컬 확률 및 데미지 계산 |
| `battle.js` | addCriticalHitEffect 함수 추가 |
| `battle.js` | renderCrew, renderEnemy에 방향 표시 |
| `battle.js` | renderEffect에 새 이펙트 타입 3종 추가 |

### 새 이펙트 타입

| 타입 | 설명 |
|------|------|
| `attack_windup` | 공격 예비 동작 (조준/스윙) |
| `crit_particle` | 크리티컬 파티클 (8방향 방출) |
| `crit_flash` | 크리티컬 플래시 (황색 원형) |

---

## 전투 시스템 Phase 2 개선 (2026-02-03)

### 구현 항목

#### 1. 피격 반응 (Hit Reaction)
**상태:** 완료

**설명:**
유닛이 피격당할 때 플래시 효과와 넉백 적용.
공격 방향에서 밀려나는 시각적 피드백.

**구현 내용:**
- `applyHitReaction(target, sourceX, sourceY)` 함수 추가
- 플래시 효과: 150ms 동안 흰색으로 점진적 변화
- 넉백: 공격 반대 방향으로 8px 밀림 (100ms)
- 크리티컬 히트 시 1.5배 넉백

**적용 대상:**
- 크루 (적에게 피격)
- 적 (근거리/원거리 공격 피격)

---

#### 2. 향상된 사망 애니메이션
**상태:** 완료

**설명:**
유닛 사망 시 더 역동적인 시각 효과 제공.

**구현 내용:**
- `triggerDeathAnimation(entity, entityType)` 함수 추가
- 크루 사망: 12개 파티클 + 영혼 상승 효과 + 화면 흔들림(5px)
- 적 사망: 8개 파티클 + 화면 흔들림(3px)

**새 이펙트:**
- `death_burst`: 중앙 플래시 + 방사형 파티클 + 충격파
- `soul_rise`: 영혼 오브 상승 + 글로우 + 트레일

---

#### 3. 스킬 발동 이펙트
**상태:** 완료

**설명:**
스킬/장비/레이븐 능력 사용 시 시각적 피드백.

**구현 내용:**
- 스킬 사용: 유닛 위치에 `skill_activate` 효과 (유닛 색상)
- 장비 사용: 유닛 위치에 황금색 효과
- 레이븐 능력: 타겟 위치에 적색 효과

**새 이펙트:**
- `skill_activate`: 회전하는 룬 + 중앙 버스트 + 내부 글로우

---

#### 4. 상태 효과 시각화
**상태:** 완료

**설명:**
버프/디버프 적용 시 시각적 피드백.

**새 이펙트:**
- `status_apply`: 아이콘 상승 + 소용돌이 파티클
- `hit_impact`: 충격 링 + 십자 표시

---

### 변경된 파일

| 파일 | 변경 내용 |
|------|----------|
| `battle.js` | `applyHitReaction()` 함수 추가 |
| `battle.js` | `triggerDeathAnimation()` 함수 추가 |
| `battle.js` | `updateCrew/updateEnemy`에 플래시/넉백 처리 |
| `battle.js` | `renderCrew/renderEnemy`에 플래시 렌더링 |
| `battle.js` | `executeTargetedAction`에 스킬 이펙트 추가 |
| `battle.js` | `renderEffect`에 새 이펙트 타입 5종 추가 |

### 새 이펙트 타입

| 타입 | 설명 |
|------|------|
| `hit_impact` | 피격 충격 (링 + 십자) |
| `death_burst` | 사망 폭발 (파티클 + 충격파) |
| `soul_rise` | 영혼 상승 (크루 사망 시) |
| `skill_activate` | 스킬 발동 (룬 회전 + 버스트) |
| `status_apply` | 상태 적용 (아이콘 + 소용돌이) |

### 시스템 변경 사항

**유닛 속성 추가:**
```javascript
// 피격 반응용 속성
entity.flashTime = 0;      // 플래시 남은 시간 (ms)
entity.knockbackX = 0;     // X축 넉백 거리
entity.knockbackY = 0;     // Y축 넉백 거리
entity.knockbackTime = 0;  // 넉백 남은 시간 (ms)
```

**타이밍:**
- 플래시 지속: 150ms
- 넉백 지속: 100ms
- 사망 버스트: 600ms
- 영혼 상승: 1000ms
- 스킬 발동: 300~500ms

---

## 전투 시스템 Phase 3 개선 (2026-02-03)

### 구현 항목

#### 1. 향상된 투사체 시각화
**상태:** 완료

**설명:**
투사체에 긴 트레일과 글로우 효과 추가.
크리티컬 투사체는 황금색으로 강조.

**구현 내용:**
- 8프레임 트레일 기록 및 페이딩 렌더링
- 글로우 효과 (반투명 큰 원)
- 크리티컬 투사체: 황금색 + 흰색 중심점
- 트레일 두께/투명도 점진적 변화

---

#### 2. 부드러운 체력바 전환
**상태:** 완료

**설명:**
체력 감소 시 즉시 변하지 않고 부드럽게 전환.
피해량을 시각적으로 확인 가능.

**구현 내용:**
- `displayHealth` 속성으로 표시 체력 관리
- 15% 보간으로 부드러운 전환
- 빨간색 "데미지 표시" 바 추가 (감소 중인 체력 표시)
- 크루/적 모두 적용

---

#### 3. 유닛 대기 애니메이션
**상태:** 완료

**설명:**
대기 상태의 유닛이 "숨쉬는" 효과로 생동감 부여.

**구현 내용:**
- `idlePhase` 속성으로 개별 위상 관리
- 사인파 기반 크기 변화 (±3%)
- 대기 상태에서만 활성화
- 모든 원형 요소(본체, 쉴드, 무적)에 적용

---

#### 4. 전투 상태 표시
**상태:** 완료

**설명:**
전투 중인 유닛 주변에 펄싱 링 표시.

**구현 내용:**
- 공격 상태: 빨간색 펄싱 링
- 펄스 주기: 250ms
- 확장되면서 페이드아웃

---

#### 5. 웨이브 전환 효과
**상태:** 완료

**설명:**
웨이브 시작 시 화면 중앙에서 확장되는 시각 효과.

**구현 내용:**
- `wave_start`: 확장 링 + 글로우 + 웨이브 번호
- `boss_entrance`: 다중 링 + 위험 선 + 해골 아이콘
- 보스: 황금색, 일반: 파란색
- 화면 흔들림 동반

---

### 변경된 파일

| 파일 | 변경 내용 |
|------|----------|
| `battle.js` | `renderProjectile` 트레일/글로우 추가 |
| `battle.js` | `renderCrew` 호흡/전투상태/부드러운 HP |
| `battle.js` | `renderEnemy` 부드러운 HP 추가 |
| `battle.js` | `showWaveAnnouncement` 웨이브 효과 추가 |
| `battle.js` | `renderEffect`에 새 이펙트 타입 3종 추가 |

### 새 이펙트 타입

| 타입 | 설명 |
|------|------|
| `wave_start` | 웨이브 시작 (확장 링 + 글로우) |
| `boss_entrance` | 보스 등장 (다중 링 + 위험 선) |
| `projectile_impact` | 투사체 충돌 (스플래시 파티클) |

### 시스템 변경 사항

**유닛 속성 추가:**
```javascript
// Phase 3 렌더링용 속성
entity.displayHealth;  // 표시용 체력 (부드러운 전환)
entity.idlePhase;      // 호흡 애니메이션 위상

// 투사체 속성
projectile.trailPositions = [];  // 트레일 위치 기록
```

**애니메이션 파라미터:**
- 체력바 보간: 15%/프레임
- 호흡 진폭: ±3%
- 호흡 주기: 2Hz
- 전투 펄스 주기: 4Hz
- 트레일 길이: 8프레임

---

## 2.5D 아이소메트릭 렌더링 연동 확인 (2026-02-03)

### 시스템 구조
세션 4에서 구현된 2.5D 아이소메트릭 렌더링 시스템:

**핵심 모듈 (demo/js/rendering/):**
| 파일 | 역할 |
|------|------|
| `isometric-renderer.js` | 좌표 변환, 카메라 시스템 |
| `height-system.js` | 타일 높이 매핑 (0-3 레벨) |
| `tile-renderer.js` | 타일/시설/스폰포인트 렌더링 |
| `depth-sorter.js` | 깊이 정렬, 엔티티 선택 |

**렌더링 모드:**
- `useIsometric: true` (기본값) → 아이소메트릭 렌더링
- `useIsometric: false` → 레거시 그리드 렌더링

### Phase 1-3 연동 상태

**발견된 문제:**
아이소메트릭 렌더 함수(`renderCrewIsometric`, `renderEnemyIsometric`)에
Phase 1-3 개선사항이 부분적으로만 적용되어 있었음.

**수정 완료:**

#### renderCrewIsometric
- ✅ Phase 1: 방향 표시기 (기존)
- ✅ Phase 2: 플래시 효과 (기존)
- ✅ Phase 3: 부드러운 체력바 (추가)
- ✅ Phase 3: 호흡 애니메이션 (추가)
- ✅ Phase 3: 전투 상태 표시 (추가)

#### renderEnemyIsometric
- ✅ Phase 1: 방향 표시기 (기존)
- ✅ Phase 2: 향상된 플래시 효과 (수정 - 그라데이션)
- ✅ Phase 3: 부드러운 체력바 (추가)

### 주요 변경사항

```javascript
// renderCrewIsometric에 추가
- crew.displayHealth 부드러운 전환
- crew.idlePhase 호흡 애니메이션
- breathScale 적용 (본체, 쉴드, 무적)
- 전투 상태 펄싱 링

// renderEnemyIsometric에 추가
- enemy.displayHealth 부드러운 전환
- 향상된 플래시 (흰색 단색 → 그라데이션)
- 데미지 표시 바 (흰색)
```

### 렌더링 경로 확인

두 가지 렌더링 경로가 동기화됨:

```
아이소메트릭 모드:
render() → renderStationIsometric() → renderEntitiesIsometric()
        → renderCrewIsometric(crew)   [Phase 1-3 적용됨]
        → renderEnemyIsometric(enemy) [Phase 1-3 적용됨]

레거시 모드:
render() → renderStation() → crews.forEach(renderCrew)
        → renderCrew(crew)   [Phase 1-3 적용됨]
        → renderEnemy(enemy) [Phase 1-3 적용됨]
```

### 향후 고려사항
1. 새로운 시각 효과 추가 시 양쪽 렌더 함수 모두 업데이트 필요
2. 공통 로직은 별도 유틸리티로 추출 검토
3. 아이소메트릭 전용 효과 (높이 기반 그림자 등) 추가 가능

---

## 이펙트 좌표 시스템 수정 (2026-02-03)

### 문제점
아이소메트릭 모드에서 이펙트가 잘못된 위치에 표시됨.
- 엔티티 좌표(타일 좌표)를 이펙트 좌표(화면 좌표)로 직접 사용
- 투사체 충돌 검사도 좌표 시스템 불일치

### 해결 방법
좌표 변환 헬퍼 함수 추가 및 이펙트 추가 코드 수정.

**새 헬퍼 함수:**
```javascript
getEffectPos(entity)     // 엔티티의 화면 좌표 반환
addEffectAtEntity(entity, effectProps)  // 엔티티 위치에 이펙트 추가
```

### 수정된 함수

| 함수 | 변경 내용 |
|------|----------|
| `crewAttack()` | 화면 좌표로 windup/melee_hit 이펙트 |
| `enemyAttack()` | 화면 좌표로 windup 이펙트 |
| `applyHitReaction()` | 소스 엔티티 객체로 방향 계산 |
| `triggerDeathAnimation()` | 화면 좌표로 death_burst/soul_rise |
| `addCriticalHitEffect()` | 엔티티 객체로 파라미터 변경 |
| `executeTargetedAction()` | `addEffectAtEntity` 사용 |
| `updateProjectile()` | 충돌 검사에 화면 좌표 사용 |

### 투사체 시스템 수정
- 투사체 생성: 화면 좌표로 시작 위치 설정
- 충돌 검사: 대상 엔티티의 화면 좌표로 거리 계산
- 데미지 숫자: 화면 좌표에 표시

### 좌표 시스템 요약
```
레거시 모드:
- entity.x/y = 화면 좌표
- effect.x/y = 화면 좌표
- 변환 불필요

아이소메트릭 모드:
- entity.x/y = 타일 좌표
- effect.x/y = 화면 좌표
- getEffectPos() 또는 addEffectAtEntity() 사용 필수
```

---

## 크루 분대원 시각화 (2026-02-03)

### 구현 내용
크루 주변에 분대원을 사람 형상(타원형)으로 시각화.

**시각 요소:**
- 메인 크루 원 주변에 분대원 배치
- 각 분대원은 머리(원) + 몸통(타원)으로 표현
- 생존 분대원: 크루 색상, 흰색 테두리
- 사망 분대원: 회색, 30% 투명도

**레이아웃:**
- 분대원 반경: 30px (호흡 스케일 적용)
- 머리: 2.5px 반경 원
- 몸통: 3x5px 타원
- 원형 배치 (12시 방향부터 시작)

**변경된 파일:**
- `renderCrew()` - 레거시 모드
- `renderCrewIsometric()` - 아이소메트릭 모드

**UI 개선:**
- 체력바 위치 조정 (y - 38)
- 분대 수 표시 형식: `현재/최대` (예: 4/6)
