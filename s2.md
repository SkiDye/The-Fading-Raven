# 세션 2: 전투 시스템

## 담당 범위
- 타일 기반 전투 그리드
- 크루 스킬 시스템
- 장비 효과 적용
- 투사체/이펙트

## 구현 항목
1. **타일 그리드 시스템** (`js/core/tile-grid.js`)
   - 타일 타입 (floor, wall, cover, spawn)
   - 경로 탐색 (A*)
   - 시야선 계산

2. **전투 엔진 리팩토링** (`js/pages/battle.js`)
   - 타일 기반 이동
   - 턴/실시간 하이브리드
   - 슬로우 모션 시스템

3. **스킬 시스템** (`js/core/skills.js`)
   - Shield Bash, Lance Charge, Volley Fire
   - Deploy Turret, Blink
   - 쿨다운, 범위, 효과

4. **장비 효과** (`js/core/equipment-effects.js`)
   - 패시브 효과 적용
   - 액티브 장비 사용
   - 소모품 관리

5. **터렛 시스템** (`js/entities/turret.js`)
   - 자동 타겟팅
   - 해킹 가능 상태

6. **Raven 드론** (`js/core/raven.js`)
   - Scout, Flare, Resupply, Orbital Strike
   - 사용 횟수 관리

## 산출물
- 리팩토링된 `battle.js`
- 새 모듈 4-5개
- `docs/implementation/combat-system.md`

---

## 통합 테스트 피드백 (2026-02-03)

### 테스트 결과
```
Session 2: Combat System - 25/25 ✓ (100%)
```

### 검증된 항목
- [x] TileGrid 로드 및 API (init, getTile, isWalkable, findPath, hasLineOfSight)
- [x] SkillSystem 로드 및 API (initCrew, isSkillReady, useSkill, getCooldownPercent)
- [x] EquipmentEffects 로드 및 API (initCrew, canUse, use)
- [x] TurretSystem 로드 및 API (create, update, canBeHacked)
- [x] RavenSystem 로드 및 API (init, canUse, useAbility, getAllAbilities)
- [x] Raven 능력 4개 확인 (Scout, Flare, Resupply, Orbital Strike)

### 발견된 이슈

#### M-001: battle.html 스크립트 로드 확인 필요 ✅ 수정완료
**우선순위:** Medium

**설명:**
`battle.html`에서 일부 Session 2 모듈 스크립트가 누락되어 있을 수 있음.

**수정 내용:**
다음 스크립트를 `battle.html`에 추가:
- ✓ tile-grid.js
- ✓ skills.js
- ✓ equipment-effects.js
- ✓ raven.js
- ✓ turret.js
- ✓ wave-generator.js (Session 3)
- ✓ wave-manager.js (Session 3)
- ✓ station-generator.js (Session 4)

### 권장 개선사항
1. 스킬 이펙트 시각화 강화
2. 터렛 해킹 진행률 UI 표시
3. Raven 능력 범위 표시 개선

---

## UX 플로우 검증 피드백 (2026-02-03)

### 전투 페이지 관련 이슈

#### H-004: WaveManager 없을 때 폴백 처리 ✅ 수정완료
**우선순위:** High

**설명:**
전투 시작 시 WaveManager가 로드되지 않은 경우 웨이브 시스템이 작동하지 않음.
사용자에게 명확한 에러 메시지 없이 전투가 멈춤.

**발생 조건:**
- wave-manager.js 스크립트 로드 실패
- 스크립트 로드 순서 오류

**수정 내용:**
- `useFallbackWaves` 플래그 추가
- Toast 경고 메시지 표시: "웨이브 시스템 제한 모드로 실행 중"
- 기존 폴백 웨이브 로직으로 전투 계속 진행

---

#### H-005: 화면 쉐이크 중 클릭 오프셋 ✅ 수정완료
**우선순위:** High

**설명:**
ScreenEffects.shake() 실행 중 캔버스 클릭 좌표가 시각적 위치와 불일치.
크루 선택이나 이동 명령이 의도한 위치와 다르게 처리됨.

**수정 내용:**
```javascript
getAdjustedClickPosition(e) {
    const rect = this.canvas.getBoundingClientRect();
    return {
        x: e.clientX - rect.left - this.shakeOffset.x,
        y: e.clientY - rect.top - this.shakeOffset.y,
    };
}
```
- `handleCanvasClick`, `handleCanvasRightClick`, `handleCanvasMouseMove`에 적용
- shakeOffset 보정으로 정확한 클릭 위치 계산

---

#### M-006: 전투 일시정지 중 스킬 사용 방지 ✅ 수정완료
**우선순위:** Medium

**설명:**
전투 일시정지 상태에서도 스킬 버튼이 활성화되어 있음.
일시정지 중 스킬 사용 시 혼란스러운 동작 발생 가능.

**수정 내용:**
- `startSkillTargeting()`, `startEquipmentTargeting()`, `startRavenTargeting()`에 `if (this.paused) return;` 가드 추가
- 일시정지 중 타겟팅 모드 진입 차단

---

#### M-007: 크루 선택 해제 방법 불명확 ✅ 수정완료
**우선순위:** Medium

**설명:**
크루 선택 후 해제하는 방법(빈 공간 클릭, ESC 등)이
UI에서 명확히 안내되지 않음.

**수정 내용:**
- 선택 패널에 ✕ 버튼 추가 (우측 상단)
- "ESC로 선택 해제" 힌트 텍스트 추가 (우측 하단)
- battle.css에 `.deselect-btn`, `.deselect-hint` 스타일 추가
- 버튼 클릭 이벤트 핸들러 추가

---

### 전투 플로우 검증 체크리스트

| 항목 | 상태 | 비고 |
|------|------|------|
| 크루 배치 표시 | ⚠️ | 초기 위치 표시 필요 |
| 적 스폰 애니메이션 | ✓ | 정상 |
| 스킬 쿨다운 표시 | ✓ | 정상 |
| 장비 사용 피드백 | ⚠️ | 성공/실패 구분 필요 |
| 웨이브 전환 | ✓ | 정상 |
| 승리/패배 판정 | ⚠️ | 결과 페이지 연결 확인 필요 |

---

### 추가 검증 필요 항목 ✅ 모두 완료
1. [x] 타일 기반 이동 시 경로 표시 - `displayPath` 저장 및 `renderMovementPaths()` 추가
2. [x] 사거리 밖 이동 명령 피드백 - `showMovementFeedback()` 및 `move_blocked` 이펙트 추가
3. [x] 슬로우 모션 중 UI 반응성 - JavaScript 이벤트 기반으로 정상 동작 확인
4. [x] 멀티터치/드래그 지원 - `handleTouchStart/Move/End` 터치 이벤트 핸들러 추가

---

## 추가 개선 작업 (2026-02-03)

### 크루 AI 시스템 추가 ✅ 완료
**파일:** `js/ai/crew-ai.js`

**구현 내용:**
- 클래스별 AI 프로필 (guardian, sentinel, ranger, engineer, bionic)
  - `preferredRange`: melee/ranged 선호 거리
  - `positioning`: frontline/backline 위치 선호
  - `skillPriority`: offensive/defensive/support 스킬 우선순위
  - `retreatThreshold`: HP 비율별 후퇴 기준
  - `aggressiveness`: 공격 성향 수치

- 위협 평가 시스템
  - 적별 위협 점수 계산 (거리, 공격력, HP, 공격 상태)
  - 정렬된 위협 목록 반환

- 자동 스킬/장비 사용
  - 클래스별 맞춤 스킬 사용 로직
  - 상황 기반 장비 사용 (체력 회복, 수류탄 등)

- 포지셔닝/후퇴 로직
  - 레인저: 최적 사거리 유지 (150px)
  - 저체력 시 자동 후퇴
  - 엄폐물 탐색 및 이동

### 맵 생성 시스템 개선 ✅ 완료
**파일:** `js/core/station-generator.js`, `js/core/tile-grid.js`

**난이도별 복잡도 개선:**
- 맵 크기 확대: 5x5~11x11 → 7x7~13x13
- BSP 세분화 깊이 조절: `maxBspDepth` (2~5)
- 추가 복도 비율: `extraCorridorRate` (10%~40%)
- 스폰 포인트 확대: 2~5개

**새로운 타일 타입:**
- `COVER` (8): 엄폐물 - 방어력 +25%
- `HAZARD` (9): 위험지역 - 매 턴 5 데미지
- `CHOKE` (10): 초크포인트 - 방어력 +10%

**특수 방 타입:**
- `DEFENSE_POST`: 중앙 고지대 + 모서리 엄폐물
- `STORAGE`: 산재한 엄폐물
- `HAZARD_ZONE`: 위험지역 포함
- `CHOKEPOINT`: 좁은 방어 거점

**지형 다양성:**
- 지형 클러스터링 (단일 타일 → 연결된 영역)
- 복도 교차점 자동 초크포인트화
- 방 타입별 특수 지형 자동 생성
- 난이도별 지형 밀도 조절

**TileGrid 통합:**
- `initFromStation()`: StationGenerator 레이아웃 초기화
- `getTerrainModifier()`: 타일별 전투 보정치 반환
- 새 타일 타입 지원 (elevated, lowered, cover, hazard, choke)
